
<!DOCTYPE HTML> 
<html lang="en"> 
<head>
<title>Looper 2: PEER2</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta http-equiv="Content-Language" content="en-us"> 

<link href="fancy.css" rel="stylesheet" type="text/css">
<style>
  #chatbox {
    background-color: #FFF;
    width: 250px;
    text-align: center;
    padding: 10px;
    float: right;
    height: 800px;
  }
  ul#chat{
    text-align: left;
  }
</style>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script src="https://rawgit.com/nexus-js/ui/master/dist/NexusUI.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/0.12.66/Tone.js"></script>
<script type="text/javascript" src="./peer.js"></script>
<script type="text/javascript" src="./node.js"></script>
</head>
<body>
  <h1 id='node-id'>Node Id: </h1>
  <h2 id='station-id'>Station Id: </h2>
  <div id='chatbox'>
    <ul id="chat"></ul>
    <form id="send">
      <input type="text" id="text" placeholder="Enter message"><input class="button" type="submit" value="Send">
    </form>
  </div>
  <div id="wrap">
    <div id="looper">
      <div id="seq"></div>
      <button onclick="start()">start</button>
      <button onclick="stop()">stop</button>
    </div>
  </div>
<script type="text/javascript">
  let node = new Node(generateId());
  $('#node-id').text(`Node Id: ${node.node.id}`);
  if(window.location.hash) {
    // find station id from url hash
    var stationId = window.location.hash.substring(1);
    $('#station-id').text(`Station Id: ${stationId}`);
    node.connect(stationId);
  } else {
    // no station id given
  }
  // Send a chat message to all active connections.
  $('#send').submit(function(e) {
    e.preventDefault();
    var msg = $('#text').val();
    node.connections.forEach((nodeId) => {
      node.transmitMsg(nodeId, msg);
    });
    displayMsg(node.node.id, msg);
    $('#text').val('');
    $('#text').focus();
  });
</script>
<script>
  var t;
  var audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  var sequencer = new Nexus.Sequencer('#seq',{
   'size': [800,200],
   'mode': 'toggle',
   'rows': 4,
   'columns': 16
  })

  var keys = new Tone.Players({
    "bass" : "https://raw.githubusercontent.com/Tonejs/Tone.js/master/examples/audio/loop/bass.mp3",
    "kick" : "https://raw.githubusercontent.com/Tonejs/Tone.js/master/examples/audio/loop/kick.mp3",
    "snare" : "https://raw.githubusercontent.com/Tonejs/Tone.js/master/examples/audio/loop/snare.mp3",
    "F#" : "https://raw.githubusercontent.com/Tonejs/Tone.js/master/examples/audio/casio/Fs2.mp3",
  }, {
    "volume" : -10,
    "fadeOut" : "64n",
  }).toMaster();

  var noteNames = ["bass", "kick", "snare", "F#"];
  var loop = new Tone.Sequence(function(time, col){
    t = time;
    sequencer.next();
  }, [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15], "16n");
  Tone.Transport.start();

  sequencer.on('step',function(v) {
    console.log(v);
    for (var i = 0; i < 4; i++){
      if (v[i] === 1){
        var vel = Math.random() * 0.5 + 0.5; //slightly randomized velocities
        keys.get(noteNames[i]).start(t, 0, "32n", 0, vel);
      }
    }
  })

  sequencer.on('change',function(data) {
    // console.log(data);
    seqChange(data);
  })

  function start() {
    loop.start();
  }

  function stop() {
    loop.stop();
  }

  Nexus.context = audioCtx;

  function seqChange(data) {
    node.connections.forEach( (nid) => {
      node.transmitSeqChange(nid, data);
    });
  }

  function updateSeq(data){
    sequencer.matrix.set.cell(data.column, data.row, data.state);
    //$('#messages').append($('<li>').text("set [" + data.row + ", " + data.column + "] to " + data.state));
  }
</script>
</body>
</html>